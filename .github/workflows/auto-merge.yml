# Workflow to cherry-pick changes from main to release branch.

name: auto-merge

on:
  push:
    branches: [ main ]

jobs:
  pick-test-push:
    strategy:
      fail-fast: false

    runs-on: ubuntu-latest
    if: github.event.repository.fork == false

    permissions:
      contents: write

    steps:
      # Checkout
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: 2.3.5-release
  
      - name: merge commits from main to release branch
        run: |
          # Cherry pick new changes from main, except for version bumps.
          # A commit is a version bump IFF it touches third_party/prebuilt/repo
          DONT_PICK=$(cat <<EOF
          5c073ba9c1283190467937b4456be9174b9be86c
          EOF
          )
          git config --global user.email "kotlin-symbol-processing@google.com"
          git config --global user.name "KSP Auto Pick"
          MERGE_BASE=$(git merge-base HEAD origin/main)
          CANDIDATES=$(git log --pretty=%H $MERGE_BASE..origin/main)
          PICKED=$(git log $MERGE_BASE..HEAD | sed -n "s/^[ ]*(cherry picked from commit \([a-z0-9]*\))$/\1/p")
          VERSION_BUMPS=$(git log $MERGE_BASE..origin/main --pretty=%H --grep UPDATE_KOTLIN_VERSION)
          TO_PICK=$(grep -Fxv -f <(echo "$PICKED"; echo "$VERSION_BUMPS"; echo "$DONT_PICK") <(echo "$CANDIDATES") | awk '{a[i++]=$0} END {for (j=i-1; j>=0;) print a[j--] }')
          echo Picking $TO_PICK
          if [ -n "$TO_PICK" ]; then git cherry-pick -x --allow-empty $TO_PICK; fi

      - uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'zulu'

      # Build cache
      - name: Cache Gradle
        uses: gradle/actions/setup-gradle@v5

      # Run build
      - name: build
        run: ./gradlew --stacktrace --info build

      - name: push to release branch
        if: success()
        run: git fetch && git rebase && git push origin
